<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- custom user theme -->
    <link rel="stylesheet" href="css/theme/tables.css">
    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <section>
                    <h1>Вспомним,</h1>
                    <h3>Чему мы научились в дистанционной части</h3>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <p>Это мы умеем</p>
                    <pre><code data-trim>
            select distinct 
                col1, col2 as column2, col3 column3, col4 [column 4], 
                case 
                    when datediff(month, col5, current_timestamp) < 5 then 1
                    else 0
                end as col5_modified, --Болгов, 2017-09-07
                len(col6) as len_col_6,
                col7 + '_' + isnull(col8, '') as col7_and_col8,
                cast('24' as int) as twenty_four,
                *
            from table
            where col1 <= 0 or col2 like '%pattern%' and col3 is null
            order by col4 desc, col2 asc, col1
                                    </code></pre>
                                    <h4>&darr;</h4>
                    <aside class=notes>
                        Что знакомого в запросе? Что происходит в каждом столбце?
                    </aside>
                </section>
                <section>
                    <p>Каков логический порядок выполнения запроса?</p>
                    <pre><code data-trim data-noescape class="sql">
            select distinct 
                case 
                    when datediff(month, col5, current_timestamp) < 5 then 1
                    else 0
                end as col5_modified
            from table
            where col1 <= 0 or col2 like '%pattern%' and col3 is null
            order by col5_modified desc
                                    </code></pre>
                    <pre class="fragment"><code>1. from table</code></pre>
                    <pre class="fragment"><code>2. where --какой порядок?</code></pre>
                    <pre class="fragment"><code>3. case ... as col5_modified</code></pre>
                    <pre class="fragment"><code>4. distinct</code></pre>
                    <pre class="fragment"><code>5. order by col5_modified desc</code></pre>
                    <pre class="fragment"><code>6. select</code></pre>
                </section>
            </section>
            <section>
                <h1>Запросы к нескольким таблицам</h1>
                <aside class=notes>
                    До сих пор мы работали только с единственной таблицей, но, данные, описывающие какую-то либо сущность, обычно разбиты на
                    несколько таблиц и хранятся в в них. Этот процесс известен как нормализация
                </aside>
            </section>
            <section>
                <p>Данные, описывающие объект, обычно хранятся в множестве таблиц</p>
                <br>
                <p>
                    <strong>Нормализация</strong> - это процесс преобразования данных, устраняющий:
                    <ul>
                        <li>Избыточность</li>
                        <li>Логические ошибки</li>
                        <li>Аномалии обновления</li>
                    </ul>
                </p>
                <aside class=notes>
                    Нормализация, как правило, нацелена на то, чтобы хранились только первичные факты (а не факты, выводимые из других)
                </aside>
            </section>
            <section>
                <section>
                    <p>Попробуем нормализовать таблицу</p>
                    <table class="table-small">
                        <tbody>
                            <tr>
                                <th>FullName</th>
                                <td>Болгов Александр Викторович</td>
                            </tr>
                            <tr>
                                <th>BirthDate</th>
                                <td>1988-05-30</td>
                            </tr>
                            <tr>
                                <th>HireDate</th>
                                <td>2014-04-01</td>
                            </tr>
                            <tr>
                                <th>HireAge</th>
                                <td>24</td>
                            </tr>
                            <tr>
                                <th>Department</th>
                                <td>Казначейство/ОБАС ALM</td>
                            </tr>
                            <tr>
                                <th>Salary</th>
                                <td>890</td>
                            </tr>
                            <tr>
                                <th>BossFullName</th>
                                <td>Нейштадт Игорь Анатольевич</td>
                            </tr>
                            <tr>
                                <th>SalaryDiffWithBoss</th>
                                <td>1000</td>
                            </tr>
                        </tbody>
                    </table>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h4>Идеи</h4>
                    <ul>
                        <li class=fragment>Разбить ФИО на три поля</li>
                        <li class=fragment>Не хранить HireAge</li>
                        <li class=fragment>Нужна таблица департаментов</li>
                        <li class=fragment>Сотрудник должен иметь id</li>
                        <li class=fragment>Босс должен быть указан ссылкой</li>
                        <li class=fragment>Не хранить разницу зарплат</li>
                    </ul>
                    <h4 class=fragment>&darr;</h4>
                </section>
                <section>
                    <div class="left">
                        <table class="table-small">
                            <tr>
                                <td><span class="fragment">PK</span></td>
                                <th>EmployeeId</th>
                                <td>1</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>FirstName</th>
                                <td>Александр</td>
                                <td>Игорь</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>MiddleName</th>
                                <td>Викторович</td>
                                <td>Анатольевич</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>LastName</th>
                                <td>Болгов</td>
                                <td>Нейштадт</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>HireDate</th>
                                <td>2014-04-01</td>
                                <td>NULL</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>BirthDate</th>
                                <td>1988-05-30</td>
                                <td>NULL</td>
                            </tr>
                            <tr>
                                <td><span class="fragment">FK</span></td>
                                <th>DepartmentId</th>
                                <td>101</td>
                                <td>101</td>
                            </tr>
                            <tr>
                                <td><span class="fragment">FK</span></td>
                                <th>BoossId</th>
                                <td>2</td>
                                <td>NULL</td>
                            </tr>
                            <tr>
                                <td></td>
                                <th>Salary</th>
                                <td>890</td>
                                <td>1890</td>
                            </tr>
                        </table>
                    </div>
                    <div class="right">
                        <table class="table-small">
                            <tr>
                                <td><span class="fragment">PK</span></td>
                                <th>DepartmentId</th>
                                <td>101</td>
                            </tr>
                            <tr>
                                <td><span class="fragment">UK</span></td>
                                <th>DepartmentName</th>
                                <td>ОБАС ALM</td>
                            </tr>
                        </table>
                    </div>
                </section>
                <aside class="notes">
                    Давайте рассмотрим таблицу, которую мог создать один из менеджеров. Какие вы могли бы сделать предложения по улучшению структуры
                    таблицы? 5 Минут, работаем в группах, каждая группа делаем доклад 2 минуты
                </aside>
            </section>
            <section>
                <p><strong>PK</strong> - primary key, столбец (или комбинация), которое уникальным образом определяет запись
                    в таблице. Бизнес-смысла нет.</p>
                <p class=fragment><strong>UK</strong> - Unique key, уникальная комбинация столбцов. Как правило, имеет бизнес-смысл.</p>
                <p class=fragment><strong>FK</strong> - Foreign key, ограничение, гарантирующее, что значения в столбце будут только из множества
                    значений определенного PK</p>
            </section>
            <section>
                <section>
                    <h1>Учебная БД</h1>
                    <h1>&darr;</h1>
                </section>
                <section data-background-image="pictures/dw-schema.png" data-background-size="100%"></section>

            </section>
            <section>
                <h3>Соединение таблиц</h3>
                <p>Для соединения двух и более таблиц используется оператор
                    <mark>JOIN</mark>
                </p>
                <p class=fragment>* Похож на ВПР (vlookup)</p>
            </section>
            <section>
                <div class=left>
                    <table class="table-small">
                        <caption>EnglishNumbers</caption>
                        <tr>
                            <td>PK</td>
                            <th>NumberId</th>
                        </tr>
                        <tr>
                            <td></td>
                            <th>NumberName</th>
                        </tr>
                    </table>
                    <br>
                    <table class="table-small">
                        <caption>FrenchNumbers</caption>
                        <tr>
                            <td>PK</td>
                            <th>NumberId</th>
                        </tr>
                        <tr>
                            <td></td>
                            <th>NumberName</th>
                        </tr>
                    </table>
                </div>
                <div class="right">
                    <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                </div>
            </section>
            <section>
                <section>
                    <h3>Как работает JOIN?</h3>
                    <div class="left">
                        <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                        <img class="invert" src="pictures/joinmapping.png" alt="join mapping">
                    </div>
                    <div class="right">
                        <p>Для каждой строки из левой таблицы просматриваются все строки правой.</p>
                        <p>Для каждой пары строк вычисляется предикат соединения</p>
                        <p>Если
                            <mark>TRUE</mark> - пара строк попадает в выборку</p>
                    </div>
                    <h4>%darr</h4>
                </section>
                <section>
                    <p>INNER JOIN == JOIN</p>
                    <img class="invert" src="pictures/join-schema.png" alt="join-schema">
                </section>
            </section>
            <section>
                <h4>Порядок выполнения запроса</h4>
                <div class="left">
                    <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                </div>
                <div class="right">
                    <pre class="fragment"><code>1. from EnglishNumbers as e</code></pre>
                    <pre class="fragment"><code>2. join FrenchNumbers f on ...</code></pre>
                    <pre class="fragment"><code>3. where ...</code></pre>
                    <pre class="fragment"><code>4. evaluate columns</code></pre>
                    <pre class="fragment"><code>5. select</code></pre>
                </div>
            </section>
            <section>
                <p>В одном запросе можно присоединять несколько таблиц (и даже ту же самую таблицу)</p>
                <pre><code>select *
from table1 t1
join table2 t2 on t1.id = t2.id
join table3 t3 on t3.id = t2.id
join table1 t1_par on t1.parent_id = t1_par.id
....</code></pre>
            </section>
            <section>
                <section>
                    <h1>Немного практики</h1>
                    <h1>&darr;</h1>
                </section>
                <section>
                    <h3>Join - Задача 1</h3>
                    <p>Написать запрос, выбирающий для каждого продукта\товара (таблица DimProduct), его имя на английском языке
                        (EnglishProductName) и название под-категории на Английском языке(таблица DimSubCategory, столбец
                        EnglishProductSubcategoryName)
                    </p>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h3>Join - Задача 2</h3>
                    <p>Модифицируйте запрос из предыдущей задачи таким образом, чтобы выбирались только продукты\товары красного
                        цвета.
                    </p>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h3>Join - Задача 3</h3>
                    <p>Добавьте к предыдущему запросу еще название Категории продукта на английском языке.</p>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h3>Join - Задача 4*</h3>
                    <p>Написать запрос, выбирающий id сотрудников, у которых первая буква имени совпадает с первой буковй имени
                        начальника
                    </p>
                </section>
            </section>
            <section>
                <h1>Конец!</h1>
            </section>
        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        // More info about config & dependencies:
        // - https://github.com/hakimel/reveal.js#configuration
        // - https://github.com/hakimel/reveal.js#dependencies
        Reveal.initialize({
            dependencies: [
                { src: 'plugin/markdown/marked.js' },
                { src: 'plugin/markdown/markdown.js' },
                { src: 'plugin/notes/notes.js', async: true },
                { src: 'plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } }
            ]
        });
    </script>
</body>

</html>